<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Drift: MOBILE FIX</title>
    <style>
        body { margin: 0; background: #010103; color: #0ff; font-family: 'Consolas', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; }
        canvas { border: 2px solid #f00; background: #000; cursor: crosshair; max-width: 100vw; max-height: 80vh; object-fit: contain; }
        
        .overlay { position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 500; backdrop-filter: blur(10px); }
        .btn { background: #000; border: 2px solid #0ff; color: #0ff; cursor: pointer; padding: 15px 40px; font-family: inherit; font-size: 1.2rem; transition: 0.2s; margin-top: 15px; text-transform: uppercase; outline: none; }

        .platform-toggle { display: flex; gap: 10px; margin: 20px 0; }
        .p-btn { padding: 10px 20px; border: 1px solid #555; background: #111; color: #888; cursor: pointer; font-family: inherit; }
        .p-btn.active { border-color: #0f0; color: #0f0; background: #002200; box-shadow: 0 0 10px #0f0; }

        /* HUD */
        #ui { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 100; font-size: 0.9rem; }
        .nav-group { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1100; }
        .nav-btn { background: #000; border: 1px solid #0ff; color: #0ff; padding: 8px; cursor: pointer; font-family: inherit; font-size: 0.6rem; }

        /* Mobile Controls */
        #joystick-zone { 
            position: absolute; bottom: 20px; left: 20px; width: 120px; height: 120px; 
            background: rgba(255,255,255,0.05); border: 2px solid rgba(0,255,255,0.2); border-radius: 50%; 
            display: none; z-index: 1200; touch-action: none;
        }
        #joystick-stick {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: #0ff; border-radius: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #0ff; pointer-events: none;
        }
        #mobileWeaponBtn { 
            position: absolute; bottom: 30px; right: 30px; width: 90px; height: 90px; 
            border-radius: 50%; border: 4px solid #0f0; background: rgba(0,255,0,0.1); 
            color: #0f0; font-weight: bold; display: none; align-items: center; justify-content: center; 
            z-index: 1200; font-size: 0.7rem; text-align: center;
        }

        .sidebar { position: absolute; top: 0; width: 280px; height: 100%; background: rgba(5, 5, 15, 0.98); padding: 20px; transition: 0.4s; z-index: 1000; overflow-y: auto; display:none; border: 1px solid #333; }
        #shop { left: 0; border-right: 3px solid #ff0; }
        #itemStore { left: 0; border-right: 3px solid #0f0; } 
        #leaderboard { right: 0; border-left: 3px solid #0ff; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .shop-item { background: #111; border: 1px solid #333; padding: 8px; cursor: pointer; text-align: center; font-size: 0.65rem; }
        .shop-item.active-item { border-color: #0ff; background: #002222; }

        #itemPrompt { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); text-align: center; display:none; }
        .cd-bar { width: 120px; height: 6px; background: #222; border: 1px solid #0f0; margin-top: 4px; }
        #cdFill { width: 100%; height: 100%; background: #0f0; }
    </style>
</head>
<body>
    <div id="itemPrompt">
        <div id="curItemText" style="color:#0f0; font-weight:bold; font-size: 0.7rem;">READY</div>
        <div class="cd-bar"><div id="cdFill"></div></div>
    </div>

    <div id="joystick-zone"><div id="joystick-stick"></div></div>
    <div id="mobileWeaponBtn" onclick="fireWeapon()">ACTIVATE</div>

    <div id="startScreen" class="overlay">
        <h1 style="font-size: 2.5rem; color:#0ff; margin:0;">NEON DRIFT</h1>
        <div class="platform-toggle">
            <button id="pcMode" class="p-btn active" onclick="setPlatform('pc')">PC</button>
            <button id="mobileMode" class="p-btn" onclick="setPlatform('mobile')">MOBILE</button>
        </div>
        <button class="btn" onclick="initGame()">INITIATE</button>
    </div>

    <div id="deathScreen" class="overlay" style="display:none">
        <h1 style="color:#f0f;">CORE RUPTURE</h1>
        <button class="btn" onclick="resetGame()">RE-START</button>
    </div>

    <div class="nav-group">
        <button class="nav-btn" onclick="toggleMenu('shop')">GEAR</button>
        <button class="nav-btn" onclick="toggleMenu('itemStore')">WEAPON</button>
        <button class="nav-btn" onclick="toggleMenu('leaderboard')">RANKS</button>
    </div>
    
    <div id="ui">
        <div>SCORE: <span id="scoreVal">0</span></div>
        <div style="color:#ff0">UP: <span id="upCount">0</span></div>
    </div>

    <div id="shop" class="sidebar"><div id="shopGrid" class="shop-grid"></div></div>
    <div id="itemStore" class="sidebar"><div id="itemGrid" class="shop-grid"></div></div>
    <div id="leaderboard" class="sidebar"><div id="lbContent"></div></div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 900; canvas.height = 600;

        let score = 0, up = parseInt(localStorage.getItem('driftUP')) || 0;
        let gameActive = false, hue = 0, lastWeaponUse = 0, isMobile = false;
        const COOLDOWN_MS = 15000;

        const player = { x: 450, y: 300, size: 12, tx: 450, ty: 300, trail: [], speed: 0.12 };
        let activePassives = JSON.parse(localStorage.getItem('driftPassives')) || [];
        let ownedItems = JSON.parse(localStorage.getItem('driftOwned')) || ['default'];
        let weaponEquipped = localStorage.getItem('driftWeapon') || null;
        let enemies = [], points = [];

        function setPlatform(type) {
            isMobile = (type === 'mobile');
            document.getElementById('pcMode').classList.toggle('active', !isMobile);
            document.getElementById('mobileMode').classList.toggle('active', isMobile);
        }

        function initGame() {
            document.getElementById('startScreen').style.display = 'none';
            if(isMobile) {
                document.getElementById('joystick-zone').style.display = 'block';
                document.getElementById('mobileWeaponBtn').style.display = 'flex';
                player.speed = 0.2; // Faster snap for mobile
            }
            gameActive = true; loop();
        }

        function toggleMenu(id) {
            const el = document.getElementById(id);
            const isOpen = el.style.display === 'block';
            document.querySelectorAll('.sidebar').forEach(s => s.style.display = 'none');
            el.style.display = isOpen ? 'none' : 'block';
        }

        // --- COORDINATE FIX ---
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // --- JOYSTICK LOGIC ---
        const jZone = document.getElementById('joystick-zone');
        const jStick = document.getElementById('joystick-stick');
        let jActive = false;

        jZone.addEventListener('touchstart', () => jActive = true);
        window.addEventListener('touchmove', (e) => {
            if (!jActive || !isMobile) return;
            const rect = jZone.getBoundingClientRect();
            const touch = e.touches[0];
            const centerX = rect.left + rect.width/2;
            const centerY = rect.top + rect.height/2;
            
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const max = rect.width / 2;

            if (dist > max) { dx *= max/dist; dy *= max/dist; }
            
            jStick.style.left = `calc(50% + ${dx}px)`;
            jStick.style.top = `calc(50% + ${dy}px)`;

            // Map joystick to ship destination
            player.tx = player.x + (dx * 15);
            player.ty = player.y + (dy * 15);
        });
        window.addEventListener('touchend', () => {
            jActive = false;
            jStick.style.left = '50%'; jStick.style.top = '50%';
        });

        // PC Movement
        window.addEventListener('mousemove', e => {
            if (isMobile) return;
            const coords = getCanvasCoords(e);
            player.tx = coords.x; player.ty = coords.y;
        });

        function fireWeapon() {
            if (!gameActive || !weaponEquipped) return;
            const now = Date.now();
            if (now - lastWeaponUse >= COOLDOWN_MS) {
                if (weaponEquipped === 'nuke') enemies = [];
                if (weaponEquipped === 'emp') { enemies.forEach(en => en.v = 0); setTimeout(()=>enemies.forEach(en=>en.v=3), 4000); }
                if (weaponEquipped === 'gold') { for(let i=0; i<15; i++) points.push({x: Math.random()*800+50, y: Math.random()*500+50}); }
                lastWeaponUse = now;
            }
        }

        window.addEventListener('keydown', e => { if(e.key.toLowerCase()==='e') fireWeapon(); });

        function save() {
            localStorage.setItem('driftUP', up);
            localStorage.setItem('driftOwned', JSON.stringify(ownedItems));
            localStorage.setItem('driftPassives', JSON.stringify(activePassives));
            localStorage.setItem('driftWeapon', weaponEquipped || "");
        }

        function loop() {
            if (!gameActive) return;
            hue++;
            ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.fillRect(0,0,900,600);

            const elapsed = Date.now() - lastWeaponUse;
            const per = Math.min(elapsed / COOLDOWN_MS, 1);
            document.getElementById('itemPrompt').style.display = weaponEquipped ? 'block' : 'none';
            document.getElementById('cdFill').style.width = (per * 100) + "%";
            if(isMobile) document.getElementById('mobileWeaponBtn').style.opacity = per >= 1 ? "1" : "0.3";

            player.x += (player.tx - player.x) * player.speed;
            player.y += (player.ty - player.y) * player.speed;
            player.x = Math.max(10, Math.min(890, player.x));
            player.y = Math.max(10, Math.min(590, player.y));

            // Drone
            if (activePassives.includes('drone')) {
                let dx = player.x + Math.cos(hue/10)*70, dy = player.y + Math.sin(hue/10)*70;
                ctx.fillStyle = '#0f0'; ctx.fillRect(dx-4, dy-4, 8, 8);
                enemies.forEach((en, i) => { if(Math.hypot(dx-en.x, dy-en.y) < 40) enemies.splice(i,1); });
            }

            // Trail & Pilot
            player.trail.push({x: player.x, y: player.y});
            if (player.trail.length > 15) player.trail.shift();
            player.trail.forEach((t, i) => {
                ctx.globalAlpha = i/15; ctx.fillStyle = '#0ff';
                ctx.beginPath(); ctx.arc(t.x, t.y, player.size*(i/15), 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Enemies
            if (Math.random() < 0.07) enemies.push({x: Math.random()*860+20, y: -20, v: 3+(score/1500)});
            enemies.forEach((en, i) => {
                en.y += en.v;
                if (activePassives.includes('shield') && Math.hypot(player.x-en.x, player.y-en.y) < 80) en.y -= 7;
                if (Math.hypot(player.x-en.x, player.y-en.y) < 18) { gameActive = false; document.getElementById('deathScreen').style.display='flex'; }
                if (en.y > 620) { enemies.splice(i,1); score += 10; document.getElementById('scoreVal').innerText = score; }
                ctx.fillStyle = '#f0f'; ctx.fillRect(en.x-8, en.y-8, 16, 16);
            });

            // Coins
            if (Math.random() < 0.02) points.push({x: Math.random()*850+25, y: Math.random()*550+25});
            points.forEach((p, i) => {
                if (activePassives.includes('magnet') && Math.hypot(player.x-p.x, player.y-p.y) < 150) {
                    p.x += (player.x - p.x) * 0.15; p.y += (player.y - p.y) * 0.15;
                }
                if (Math.hypot(player.x-p.x, player.y-p.y) < 25) { points.splice(i,1); up += 100; save(); document.getElementById('upCount').innerText = up; }
                ctx.fillStyle = '#ff0'; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
            });

            requestAnimationFrame(loop);
        }

        function resetGame() {
            score = 0; enemies = []; points = []; gameActive = true;
            player.x = 450; player.y = 300; player.tx = 450; player.ty = 300;
            document.getElementById('deathScreen').style.display = 'none';
            loop();
        }
    </script>
</body>
</html>
