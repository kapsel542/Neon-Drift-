<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Drift: REBORN</title>
    <style>
        :root { --neon: #0ff; --toxic: #0f0; --fire: #f00; --gold: #ff0; }
        * { box-sizing: border-box; touch-action: none; -webkit-user-select: none; }
        body { margin: 0; background: #05050a; color: #fff; font-family: 'Courier New', monospace; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        
        /* CRT Effect */
        body::after { content: ""; position: absolute; inset: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%), linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03)); background-size: 100% 3px, 3px 100%; pointer-events: none; z-index: 9999; }

        canvas { border: 4px solid var(--fire); background: #000; width: 95vw; height: auto; max-height: 75vh; aspect-ratio: 9/6; box-shadow: 0 0 20px var(--fire); }

        /* Global HUD */
        #hud { position: absolute; top: 10px; width: 95vw; display: flex; justify-content: space-between; z-index: 1000; }
        .stat-box { background: rgba(0,0,0,0.8); padding: 10px; border-left: 4px solid var(--neon); }
        .nav-btns { display: flex; gap: 10px; }
        .nav-btn { background: #000; border: 2px solid var(--neon); color: var(--neon); padding: 8px 15px; cursor: pointer; font-family: inherit; font-weight: bold; }
        .nav-btn:hover { background: var(--neon); color: #000; }

        /* Menus */
        .overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 2000; }
        .sidebar { position: absolute; right: 0; top: 0; width: 320px; height: 100%; background: #0a0a15; border-left: 2px solid var(--neon); padding: 20px; z-index: 3000; display: none; overflow-y: auto; }
        
        input { background: #111; border: 2px solid var(--neon); color: var(--neon); padding: 12px; text-align: center; font-family: inherit; font-size: 1.2rem; margin-bottom: 15px; outline: none; }
        .main-btn { background: #000; border: 3px solid var(--toxic); color: var(--toxic); padding: 15px 40px; font-size: 1.5rem; cursor: pointer; font-family: inherit; }

        /* Shop Layout */
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .item-card { background: #151525; border: 1px solid #333; padding: 10px; text-align: center; cursor: pointer; font-size: 0.8rem; }
        .item-card.equipped { border-color: var(--toxic); background: #002200; }
        
        /* Mobile Controls */
        #controls { position: absolute; bottom: 20px; width: 95vw; display: none; justify-content: space-between; padding: 0 20px; z-index: 1500; }
        #joy-zone { width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 2px solid var(--neon); border-radius: 50%; position: relative; }
        #joy-stick { width: 50px; height: 50px; background: var(--neon); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px var(--neon); }
        #act-btn { width: 80px; height: 80px; border: 4px solid var(--toxic); background: rgba(0,255,0,0.1); border-radius: 50%; color: var(--toxic); font-weight: bold; display: flex; align-items: center; justify-content: center; }

        .lb-entry { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        #event-banner { position: absolute; top: 25%; width: 100%; text-align: center; font-size: 3rem; font-weight: bold; color: #f0f; z-index: 1800; display: none; text-shadow: 0 0 20px #f0f; pointer-events: none; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="stat-box">
            SCORE: <span id="sc">0</span><br>
            <span style="color:var(--gold)">UP: <span id="upc">0</span></span>
        </div>
        <div class="nav-btns">
            <button class="nav-btn" onclick="toggleMenu('shop')">GARAGE</button>
            <button class="nav-btn" onclick="toggleMenu('leaderboard')">RANKS</button>
        </div>
    </div>

    <div id="event-banner">EVENT TRIGGERED</div>

    <div id="startScreen" class="overlay">
        <h1 style="color:var(--neon); font-size: 4rem; margin:0; text-shadow: 0 0 20px var(--neon);">NEON DRIFT</h1>
        <p style="color: #666;">TYPE NICKNAME & SELECT MODE</p>
        <input type="text" id="nickInput" placeholder="PILOT_ID" maxlength="12">
        <div style="margin-bottom: 20px;">
            <button class="nav-btn" id="pcMode" onclick="setMode('pc')">PC</button>
            <button class="nav-btn" id="mobMode" onclick="setMode('mobile')">MOBILE</button>
        </div>
        <button class="main-btn" onclick="startGame()">INITIATE DRIVE</button>
    </div>

    <div id="shop" class="sidebar">
        <h2 style="color:var(--gold)">GARAGE</h2>
        <p>SKINS</p><div id="skinGrid" class="shop-grid"></div>
        <p>WEAPONS</p><div id="wepGrid" class="shop-grid"></div>
        <button class="nav-btn" style="width:100%; margin-top:20px;" onclick="toggleMenu('shop')">CLOSE</button>
    </div>

    <div id="leaderboard" class="sidebar">
        <h2 style="color:var(--neon)">TOP 100</h2>
        <div id="lbList"></div>
        <button class="nav-btn" style="width:100%; margin-top:20px;" onclick="toggleMenu('leaderboard')">CLOSE</button>
    </div>

    <div id="controls">
        <div id="joy-zone"><div id="joy-stick"></div></div>
        <div id="act-btn" onclick="useWeapon()">ACTIVATE</div>
    </div>

    <canvas id="c"></canvas>

    <script>
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        canvas.width = 900; canvas.height = 600;

        // --- Persistent State ---
        let pilot = {
            nick: localStorage.getItem('driftNick') || "RECRUIT",
            up: parseInt(localStorage.getItem('driftUP')) || 0,
            owned: JSON.parse(localStorage.getItem('driftOwned')) || ['cyan'],
            equipped: localStorage.getItem('driftSkin') || 'cyan',
            weapon: localStorage.getItem('driftWeapon') || null
        };

        const skins = {
            'cyan': '#0ff', 'fire': '#f44', 'toxic': '#0f0', 'royal': '#a0f', 'gold': '#ff0', 'void': '#333'
        };
        const items = [
            {id: 'fire', n: 'Fire Skin', p: 5000, type: 'skin'},
            {id: 'toxic', n: 'Toxic Skin', p: 5000, type: 'skin'},
            {id: 'gold', n: 'Gold Skin', p: 15000, type: 'skin'},
            {id: 'nuke', n: 'EMP Bomb', p: 10000, type: 'wep'},
            {id: 'freeze', n: 'Time Warp', p: 12000, type: 'wep'}
        ];

        // --- Game Variables ---
        let active = false, score = 0, isMobile = false;
        let player = { x: 450, y: 300, tx: 450, ty: 300, trail: [], size: 10 };
        let enemies = [], coins = [], particles = [];
        let eventActive = false, lastEventScore = 0;
        let gameSpeed = 1;

        document.getElementById('nickInput').value = pilot.nick;
        updateUI();

        function setMode(m) {
            isMobile = (m === 'mobile');
            document.getElementById('pcMode').style.background = !isMobile ? 'var(--neon)' : '#000';
            document.getElementById('mobMode').style.background = isMobile ? 'var(--neon)' : '#000';
        }

        function toggleMenu(id) {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
            if(id === 'shop') renderShop();
            if(id === 'leaderboard') renderLB();
        }

        function startGame() {
            pilot.nick = document.getElementById('nickInput').value || "PILOT";
            save();
            document.getElementById('startScreen').style.display = 'none';
            if(isMobile) document.getElementById('controls').style.display = 'flex';
            
            // Reset
            player.x = 450; player.y = 300; player.tx = 450; player.ty = 300;
            score = 0; enemies = []; coins = []; lastEventScore = 0;
            active = true;
            loop();
        }

        function die() {
            active = false;
            let lb = JSON.parse(localStorage.getItem('driftLB')) || [];
            lb.push({name: pilot.nick, score: score});
            lb.sort((a,b) => b.score - a.score);
            localStorage.setItem('driftLB', JSON.stringify(lb.slice(0, 100)));
            document.getElementById('startScreen').style.display = 'flex';
        }

        // --- Systems ---
        function save() {
            localStorage.setItem('driftNick', pilot.nick);
            localStorage.setItem('driftUP', pilot.up);
            localStorage.setItem('driftOwned', JSON.stringify(pilot.owned));
            localStorage.setItem('driftSkin', pilot.equipped);
            localStorage.setItem('driftWeapon', pilot.weapon);
            updateUI();
        }

        function updateUI() {
            document.getElementById('sc').innerText = score;
            document.getElementById('upc').innerText = pilot.up;
        }

        function renderShop() {
            document.getElementById('skinGrid').innerHTML = Object.keys(skins).map(k => `
                <div class="item-card ${pilot.equipped === k ? 'equipped' : ''}" onclick="buy('${k}', 'skin', 0)">
                    ${k.toUpperCase()}<br>${pilot.owned.includes(k) ? 'OWNED' : '5000'}
                </div>`).join('');
            document.getElementById('wepGrid').innerHTML = items.filter(i=>i.type==='wep').map(i => `
                <div class="item-card ${pilot.weapon === i.id ? 'equipped' : ''}" onclick="buy('${i.id}', 'wep', ${i.p})">
                    ${i.n}<br>${pilot.owned.includes(i.id) ? 'EQUIP' : i.p}
                </div>`).join('');
        }

        function buy(id, type, price) {
            if(!pilot.owned.includes(id)) {
                if(pilot.up >= price) {
                    pilot.up -= price;
                    pilot.owned.push(id);
                } else return;
            }
            if(type === 'skin') pilot.equipped = id;
            if(type === 'wep') pilot.weapon = id;
            save(); renderShop();
        }

        function renderLB() {
            let lb = JSON.parse(localStorage.getItem('driftLB')) || [];
            document.getElementById('lbList').innerHTML = lb.map((e, i) => `
                <div class="lb-entry"><span>#${i+1} ${e.name}</span><span>${e.score}</span></div>
            `).join('');
        }

        // --- Controls ---
        const stick = document.getElementById('joy-stick'), zone = document.getElementById('joy-zone');
        let jHeld = false;
        zone.addEventListener('touchstart', () => jHeld = true);
        window.addEventListener('touchmove', (e) => {
            if(!jHeld) return;
            const r = zone.getBoundingClientRect(), t = e.touches[0];
            const cx = r.left + r.width/2, cy = r.top + r.height/2;
            let dx = t.clientX - cx, dy = t.clientY - cy;
            const d = Math.sqrt(dx*dx + dy*dy), max = r.width/2;
            if(d > max) { dx *= max/d; dy *= max/d; }
            stick.style.left = `calc(50% + ${dx}px)`; stick.style.top = `calc(50% + ${dy}px)`;
            player.tx = player.x + (dx * 2.5); player.ty = player.y + (dy * 2.5);
        });
        window.addEventListener('touchend', () => { jHeld = false; stick.style.left='50%'; stick.style.top='50%'; });
        window.addEventListener('mousemove', (e) => {
            if(isMobile) return;
            const r = canvas.getBoundingClientRect();
            player.tx = (e.clientX - r.left) * (900 / r.width);
            player.ty = (e.clientY - r.top) * (600 / r.height);
        });

        // --- Events ---
        function triggerEvent() {
            const evts = ['BLOCK RUSH', 'COIN RAIN', 'GHOST MODE'];
            const picked = evts[Math.floor(Math.random()*evts.length)];
            const banner = document.getElementById('event-banner');
            banner.innerText = picked; banner.style.display = 'block';
            
            if(picked === 'BLOCK RUSH') gameSpeed = 2;
            if(picked === 'COIN RAIN') for(let i=0; i<40; i++) coins.push({x:Math.random()*800, y:Math.random()*500});
            if(picked === 'GHOST MODE') eventActive = true;

            setTimeout(() => {
                banner.style.display = 'none';
                gameSpeed = 1; eventActive = false;
            }, 8000);
        }

        // --- Main Loop ---
        function loop() {
            if(!active) return;
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0,0,900,600);

            // Boundary Lethality
            if(player.x < 5 || player.x > 895 || player.y < 5 || player.y > 595) die();

            // Movement
            player.x += (player.tx - player.x) * (isMobile ? 0.2 : 0.12);
            player.y += (player.ty - player.y) * (isMobile ? 0.2 : 0.12);

            // Event Trigger (Every 1500)
            if(score > 0 && score % 1500 === 0 && score !== lastEventScore) {
                lastEventScore = score;
                triggerEvent();
            }

            // Trail
            player.trail.push({x: player.x, y: player.y});
            if(player.trail.length > 20) player.trail.shift();
            player.trail.forEach((t, i) => {
                ctx.fillStyle = skins[pilot.equipped];
                ctx.globalAlpha = i/20;
                ctx.beginPath(); ctx.arc(t.x, t.y, player.size * (i/20), 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Enemies
            if(Math.random() < (gameSpeed === 2 ? 0.2 : 0.07)) {
                enemies.push({x: Math.random()*880, y: -20, v: (3 + score/2000) * gameSpeed});
            }
            enemies.forEach((en, i) => {
                en.y += en.v;
                if(!eventActive && Math.hypot(player.x-en.x, player.y-en.y) < player.size+8) die();
                if(en.y > 620) { enemies.splice(i,1); score += 10; updateUI(); }
                ctx.fillStyle = '#f0f';
                ctx.shadowBlur = 10; ctx.shadowColor = '#f0f';
                ctx.fillRect(en.x-8, en.y-8, 16, 16);
                ctx.shadowBlur = 0;
            });

            // Coins
            if(Math.random() < 0.02) coins.push({x: Math.random()*850, y: Math.random()*550});
            coins.forEach((cn, i) => {
                if(Math.hypot(player.x-cn.x, player.y-cn.y) < 25) {
                    coins.splice(i,1); pilot.up += 100; save();
                }
                ctx.fillStyle = 'var(--gold)';
                ctx.beginPath(); ctx.arc(cn.x, cn.y, 5, 0, Math.PI*2); ctx.fill();
            });

            requestAnimationFrame(loop);
        }
    </script>
</body>
</html>
